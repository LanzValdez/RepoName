name: Playwright E2E Tests

# Trigger the workflow on pull requests to main
on:
  pull_request:
    branches:
      - main

jobs:
  pre-merge-e2e:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout the code for the PR as it would be after merging
      - name: Checkout merged commit
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.merge_commit_sha }}

      # 2️⃣ Set up Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20

      # 3️⃣ Login to AWS CodeArtifact (only if using private packages)
      - name: Login to AWS CodeArtifact
        run: |
          aws codeartifact login \
            --tool npm \
            --domain sni-react-components \
            --domain-owner 345594593778 \
            --repository sni-react-components-prod \
            --region ap-southeast-1
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
          AWS_DEFAULT_REGION: ap-southeast-1

      # 4️⃣ Report pending test run to API
      - name: Report pending test run
        run: |
          curl -X POST "https://xiztysz760.execute-api.ap-southeast-1.amazonaws.com/dev/test-runs" \
          -H "Content-Type: application/json" \
          -d "$(jq -n \
              --arg pr_number "${{ github.event.repository.name }}-${{ github.event.pull_request.number }}" \
              --arg run_id "${{ github.run_id }}" \
              --arg pr_title "${{ github.event.pull_request.title }}" \
              --arg requested_by "${{ github.event.pull_request.user.login }}" \
              --arg status "pending" \
              --arg started_at "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
              --arg pr_url "${{ github.event.pull_request.html_url }}" \
              '{pr_number: $pr_number, run_id: $run_id, pr_title: $pr_title, requested_by: $requested_by, status: $status, started_at: $started_at, pr_url: $pr_url}')"


      # 5️⃣ Install dependencies
      - name: Install dependencies
        run: npm install

      # 6️⃣ Install Playwright browsers
      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      # 7️⃣ Run Playwright tests
      - name: Run Playwright tests
        id: playwright
        run: |
          npx playwright test --reporter=list
        continue-on-error: true   # Workflow continues even if tests fail

      # 8️⃣ Report test result to API
      - name: Report test result
        run: |
          STATUS="passed"
          if [ ${{ steps.playwright.outcome }} != "success" ]; then
            STATUS="failed"
          fi

          curl -X POST "https://xiztysz760.execute-api.ap-southeast-1.amazonaws.com/dev/test-runs" \
          -H "Content-Type: application/json" \
          -d "{\"pr_number\": \"${{ github.repository }}-${{ github.event.pull_request.number }}\", \
               \"run_id\": \"${{ github.run_id }}\", \
               \"status\": \"$STATUS\", \
               \"completed_at\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"}"

      # 9️⃣ Upload artifacts (screenshots/videos) for failed tests
      - name: Upload Playwright artifacts
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
