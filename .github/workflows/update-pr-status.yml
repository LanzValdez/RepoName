name: Update PR Status on Close

# Trigger on PR close (merged or rejected)
on:
  pull_request:
    types: [closed]

jobs:
  update-pr-status:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout code (optional, needed if you want repo info)
      - name: Checkout code
        uses: actions/checkout@v3

      # 2️⃣ Set PR status and completed_at
      - name: Update DynamoDB for closed PR
        run: |
          # Determine PR status
          if [ "${{ github.event.pull_request.merged }}" == "true" ]; then
            PR_STATUS="Merged"
            COMPLETED_AT=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          elif [ "${{ github.event.pull_request.merged }}" == "false" ]; then
            PR_STATUS="Rejected"
            COMPLETED_AT=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          else
            echo "PR not merged/rejected yet — skipping API call"
            exit 0
          fi


          COMPLETED_AT=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          # Call your API to update DynamoDB
          curl -X POST "https://xiztysz760.execute-api.ap-southeast-1.amazonaws.com/dev/test-runs" \
          -H "Content-Type: application/json" \
          -d "$(jq -n \
            --arg pr_number "${{ github.event.pull_request.base.repo.name }}-${{ github.event.pull_request.number }}" \
            --arg pr_status "$PR_STATUS" \
            --arg completed_at "$COMPLETED_AT" \
            '{pr_number: $pr_number, pr_status: $pr_status, completed_at: $completed_at}')"
